<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>فروشگاه ها</title>
    <style>
        .store-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        .store-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            background-color: #f9f9f9;
            text-decoration: none;
            color: inherit;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .store-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: #f0f0f0;
        }
        .alert {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
        }
        .d-none {
            display: none;
        }
        .search-container {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="search-container">
        <input type="search" placeholder="جستجوی نام و فیلد فروشگاه‌ها" aria-label="Search" id="searchInput" style="padding: 8px; width: 300px; border-radius: 4px; border: 1px solid #ddd;" />
    </div>

    <div id="message-box" class="alert d-none"></div>

    <h2>لیست فروشگاه‌ها</h2>
    <div id="store-list" class="store-grid"></div>

    <a href="http://127.0.0.1:8000/register/home/" class="btn btn-secondary w-100 mt-2">بازگشت</a>

    <script>
        let allStores = []; // برای ذخیره تمام فروشگاه‌ها
        
        function showMessage(message, type) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.className = `alert alert-${type}`;
            messageBox.classList.remove('d-none');
            
            setTimeout(() => {
                messageBox.classList.add('d-none');
            }, 5000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchStores();
            
            // اضافه کردن رویداد جستجو
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function() {
                filterStores(this.value.toLowerCase());
            });
        });

        function fetchStores() {
            fetch('/web/all_shop/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('مشکل در دریافت اطلاعات فروشگاه‌ها');
                }
                return response.json();
            })
            .then(stores => {
                allStores = stores; // ذخیره تمام فروشگاه‌ها
                renderStores(stores);
            })
            .catch(error => {
                showMessage(error.message, 'danger');
                console.error('Error loading stores:', error);
            });
        }

        function filterStores(searchText) {
            if (!searchText) {
                renderStores(allStores);
                return;
            }
            
            const filteredStores = allStores.filter(store => {
                return store.name.toLowerCase().includes(searchText) ||
                       (store.address && store.address.toLowerCase().includes(searchText)) ||
                       (store.phone && store.phone.toLowerCase().includes(searchText)) ||
                       (store.field && store.field.toLowerCase().includes(searchText));
            });
            
            renderStores(filteredStores);
        }

        function renderStores(stores) {
            const container = document.getElementById('store-list');
            container.innerHTML = '';  // اول خالی کنیم

            if (stores.length > 0) {
                stores.forEach(store => {
                    const storeUrl = `/register/shop_page/${store.id}/`;
                    container.innerHTML += `
                        <a href="${storeUrl}" class="store-card">
                            <h3>نام فروشگاه: ${store.name}</h3>
                            <p>آدرس: ${store.address || 'ثبت نشده'}</p>
                            <p>شماره تماس: ${store.phone || 'ثبت نشده'}</p>
                            <p> تعداد محصولات فروشگاه: ${store.product_count}</p>
                            <p>نوع فروشگاه: ${store.field || 'ثبت نشده'}</p>
                        </a>
                    `;
                });
            } else {
                container.innerHTML = '<p>هیچ فروشگاهی یافت نشد.</p>';
            }
        }
    </script>
</body>
</html>