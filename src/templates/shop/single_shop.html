{% extends 'base.html' %}
{% load static %}
{% block title %}صفحه فروشگاه{% endblock %}
{% block content %}


    <div class="d-flex justify-content-between flex-wrap gap-2 align-items-center mb-3">
        <input type="text" id="search-input" class="form-control w-50" placeholder="جستجو در محصولات..." />

        <select id="sort-select" class="form-select w-25">
            <option value="">مرتب‌سازی</option>
            <option value="high_price">بیشترین قیمت</option>
            <option value="low_price">کمترین قیمت</option>
            <option value="most_stock">بیشترین تعداد</option>
            <option value="least_stock">کمترین تعداد</option>
        </select>
    </div>

    <div id="shopDetails">
        <!-- اطلاعات فروشگاه در اینجا نمایش داده میشه -->
    </div>

    <div id="product-container">
        <!-- محصولات فروشگاه در اینجا نمایش داده میشه -->
    </div>
    <a href="http://127.0.0.1:8000/register/all_shop/" class="return-btn w-25 mt-2">بازگشت</a>    
{% endblock %}


{% block custom_script %}
<script>
    const pathParts = window.location.pathname.split('/');
    const shopId = pathParts[pathParts.length - 2];  // گرفتن ID از URL
    // درخواست اطلاعات فروشگاه از API

	let allProducts = []; // ذخیره همه محصولات

	async function addToCart(productId) {
	    try {
	        const response = await fetch('http://127.0.0.1:8000/cart/cart/', {
	            method: 'POST',
	            headers: {
	                'Content-Type': 'application/json',
	                'Accept': 'application/json'
	            },
	            body: JSON.stringify({
	                product_id: productId,
	                quantity: 1 // تعداد پیشفرض که میخوای اضافه بشه
	            })
	        });
		
	        if (!response.ok) {
	            throw new Error('خطا در افزودن به سبد خرید');
	        }
		
	        const result = await response.json();
	        alert('محصول به سبد خرید اضافه شد!');
	    } catch (error) {
	        console.error('Error adding to cart:', error);
	        alert('مشکلی پیش آمده. لطفا دوباره تلاش کنید.');
	    }
	}
    async function fetchShopData() {
        try {
            const response = await fetch(`/vendors/single_shop/${shopId}/`);
            if (!response.ok) {
                throw new Error('مشکل در دریافت اطلاعات فروشگاه');
            }
            const data = await response.json();
            displayShopData(data);
        } catch (error) {
            console.error('خطا:', error);
            document.getElementById('shopDetails').innerText = 'خطا در دریافت اطلاعات فروشگاه';
        }
    }
    // درخواست محصولات فروشگاه از API
    async function fetchShopProducts() {
        try {
            const response = await fetch(`/vendors/get_shop_product/${shopId}/`);
            if (!response.ok) {
                throw new Error('مشکل در دریافت محصولات فروشگاه');
            }
            const productsData = await response.json();
            allProducts = productsData;
            filterAndRenderProducts();

        } catch (error) {
            console.error('خطا در دریافت محصولات:', error);
            document.getElementById('product-container').innerText = 'خطا در دریافت محصولات';
        }
    }
    // نمایش محصولات با فرمت کارت
    function renderProducts(products) {
        const product_container = document.getElementById('product-container');
        product_container.innerHTML = '';
        
        if (products.length === 0) {
            product_container.innerHTML = '<p>محصولی برای نمایش وجود ندارد.</p>';
            return;
        }
        products.forEach(product => {
            const productHtml = `
                <div class="product-card">
                    <img src="${product.image}" alt="${product.name}" class="product-image"/>
                    <div class="product-info">
                        <div>
                            <h3>نام : ${product.name}</h3>
                            <p>امتیاز : ${product.rating || 'نامشخص'}</p>
                            <p>قیمت : ${product.final_price} تومان</p>
                            ${product.discount > 0 ? `<p>تخفیف: ${product.discount}%</p>` : ''}
                            <p>تعداد : ${product.stock}</p>
                        </div>
                        <div class="product-buttons">
                            <button onclick="addToCart(${product.id})" class="btn2">افزودن به سبد خرید</button>
                            <a href="http://127.0.0.1:8000/register/single_product/${product.id}/" class="btn">جزئیات محصول</a>
                        </div>
                    </div>
                </div>
            `;
            product_container.innerHTML += productHtml;
        });
    }
    // نمایش اطلاعات فروشگاه
    function displayShopData(shop) {
        const shopDetails = document.getElementById('shopDetails');
        shopDetails.innerHTML = `
            <h1>اسم فروشگاه: ${shop.name}</h1>
            <p>توضیحات: ${shop.description || 'ثبت نشده'}</p>
            <p>آدرس: ${shop.address}</p>
            <p>تلفن: ${shop.phone || 'ثبت نشده'}</p>
            <p>نوع فروشگاه: ${shop.field || 'ثبت نشده'}</p>
            <hr>
            <h2>محصولات فروشگاه</h2>
        `;
    }
    function filterAndRenderProducts() {
        const searchValue = document.getElementById("search-input").value.trim().toLowerCase();
        const sortValue = document.getElementById("sort-select").value;

        let filtered = allProducts.filter(product => 
            product.name.toLowerCase().includes(searchValue)
        );

        if (sortValue === 'high_price') {
            filtered.sort((a, b) => b.final_price - a.final_price);
        } else if (sortValue === 'low_price') {
            filtered.sort((a, b) => a.final_price - b.final_price);
        } else if (sortValue === 'most_stock') {
            filtered.sort((a, b) => b.stock - a.stock);
        } else if (sortValue === 'least_stock') {
            filtered.sort((a, b) => a.stock - b.stock);
        }

        renderProducts(filtered);
    }

    // بارگذاری داده‌ها هنگام بارگذاری صفحه
    document.getElementById('search-input').addEventListener('input', filterAndRenderProducts);
    document.getElementById('sort-select').addEventListener('change', filterAndRenderProducts);

    fetchShopData();
    fetchShopProducts();
</script>
{% endblock %}
</body>
</html>