{% extends 'base.html' %}

<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>کاربران فروشگاه</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
{% block content %}
<body class="bg-light" >

<div class="form-container">
  <h2 class="mb-4 text-center">کاربران</h2>

  <div id="message-box" class="alert d-none"></div>

  <form id="user-form" class="mb-4">
    <div class="mb-3">
      <label class="form-label">نام کاربری</label>
      <input type="text" class="form-control ltr-input" name="username" required>
    </div>

    <div class="mb-3">
      <label class="form-label">نقش کاربر</label>
      <select class="form-select" name="role" required>
        <option value="">انتخاب نقش...</option>
        <option value="manager">manager</option>
        <option value="operator">operator</option>
      </select>
    </div>

    <button type="submit" id="add-btn" class="btn btn-success w-100">افزودن</button>

    <button type="button" id="update-btn" class="btn btn-warning w-100 d-none mt-2">ذخیره تغییرات</button>

    <a href="http://127.0.0.1:8000/register/vendor_panel/" class="btn btn-secondary w-100 mt-2">بازگشت</a>

  </form>

  <ul id="user-list" class="list-group">

  </ul>
</div>
{% endblock %}

{% block custom_script %}
<script>
    const userForm = document.getElementById('user-form');
    const userList = document.getElementById('user-list');
    const messageBox = document.getElementById('message-box');
    const addBtn = document.getElementById('add-btn');
    const updateBtn = document.getElementById('update-btn');
    const accessToken = localStorage.getItem('access_token');

    fetch('/vendors/register_manager_or_operator/', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + accessToken,
      }
    })
    .then(response => response.json().then(json => ({status: response.status, body: json})))
    .then(({status, body}) => {
      if (status === 200) {
        displayUsers(body);
      } else {
        showMessage(body.error, 'danger');
      }
    });
  
    function displayUsers(users) {
      userList.innerHTML = '';
      users.forEach(user => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
          <div class="d-flex flex-column">
            <strong>username: ${user.username}</strong>
            <small>role: ${user.role}</small>
          </div>
          <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.username}')">حذف</button>
        `;
        userList.appendChild(li);
      });
    }

    userForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(userForm);
      const data = {};
      formData.forEach((value, key) => { data[key] = value });
  
      fetch('/vendors/register_manager_or_operator/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + accessToken,
        },
        body: JSON.stringify(data)
      })
      .then(res => res.json().then(json => ({ status: res.status, body: json })))
      .then(({ status, body }) => {
        if (status === 201) {
          showMessage('کاربر با موفقیت اضافه شد!', 'success');
          userForm.reset();
          fetchUsers();
        } else {
          let errors = '';
          for (const key in body) errors += `${key}: ${body[key]}<br>`;
          showMessage(errors, 'danger');
        }
      });
    });

    function deleteUser(username) {
      if (confirm("آیا مطمئن هستید که می‌خواهید این کاربر را حذف کنید؟")) {
        fetch(`/vendors/register_manager_or_operator/${username}/`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + accessToken,
          }
        })
        .then(res => res.json().then(json => ({ status: res.status, body: json })))
        .then(({ status, body }) => {
          if (status === 200) {
            showMessage('کاربر با موفقیت حذف شد!', 'success');
            fetchUsers();
          } else {
            showMessage(body.error || 'خطا در حذف کاربر.', 'danger');
          }
        });
      }
    }


    function fetchUsers() {
      fetch('/vendors/register_manager_or_operator/', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + accessToken,
        }
      })
      .then(res => res.json())
      .then(data => {
        displayUsers(data);
      });
    }

    function showMessage(message, type) {
      messageBox.className = 'alert alert-' + type;
      messageBox.innerHTML = message;
      messageBox.classList.remove('d-none');
    }
  </script>
{% endblock %}
</body>
</html>
