{% extends 'base.html' %}

<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت سفارش‌های فروشگاه</title>

</head>
{% block content %}
<body>
    <div class="container">
        <h1>سفارش‌های فروشگاه</h1>
        
        <div id="message-container"></div>
        
        <div id="orders-container">
            <div class="loading">در حال دریافت اطلاعات سفارش‌ها...</div>
        </div>
    </div>
    <a href="http://127.0.0.1:8000/register/vendor_panel/" class="return-btn w-100 mt-2">بازگشت</a>
{% endblock %}

{% block custom_script %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetchOrders();
        });

        function fetchOrders() {
            fetch('/cart/vendor_orders/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('مشکل در دریافت سفارش‌ها');
                }
                return response.json();
            })
            .then(data => {
                renderOrders(data);
            })
            .catch(error => {
                showMessage(error.message, 'error');
                console.error('Error:', error);
            });
        }

        function renderOrders(orders) {
            const container = document.getElementById('orders-container');
            
            if (orders.length === 0) {
                container.innerHTML = '<div class="no-orders">هیچ سفارشی یافت نشد</div>';
                return;
            }
            
            container.innerHTML = '';
            
            orders.forEach(order => {
                console.log('Order:', order);

                const orderElement = document.createElement('div');
                orderElement.className = 'order-card';
                
                // تعیین کلاس وضعیت سفارش
                let statusClass = 'status-pending';
                let statusText = 'در انتظار پرداخت';
                
                if (order.status === 'cancelled') {
                    statusClass = 'status-cancelled';
                    statusText = 'لغو شده';
                } else if (order.status === 'pending') {
                    statusClass = 'status-pending';
                    statusText = 'در انتظار پرداخت';
                } else if (order.status === 'processing') {
                    statusClass = 'status-processing';
                    statusText = 'در حال پردازش';
                } else if (order.status === 'shipped') {
                    statusClass = 'status-shipped';
                    statusText = 'درحال ارسال';
                } else if (order.status === 'delivered') {
                    statusClass = 'status-delivered';
                    statusText = 'تحویل داده شده';
                }

                // دکمه‌های عملیات
                let actionButton = '';
                if (order.status !== 'completed' && order.status !== 'cancelled') {
                    actionButton = `<button class="btn btn-cancel" onclick="cancelOrder(${order.id})">لغو سفارش</button>`;
                } else {
                    actionButton = `<button class="btn btn-disabled" disabled>لغو سفارش</button>`;
                }

                
                orderElement.innerHTML = `
                    <div class="order-header">
                        <div>
                            <span class="order-id">سفارش #${order.id}</span>
                            <span class="order-date">${new Date(order.order_date).toLocaleString('fa-IR')}</span>
                        </div>
                        <span class="order-status ${statusClass}">${statusText}</span>
                    </div>
                    
                    <div class="order-details">
                        <div class="detail-row">
                            <span class="detail-label">مشتری:</span>
                            <span>${order.customer}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">آدرس:</span>
                            <span>${order.address}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">مبلغ کل:</span>
                            <span class="price">${order.total_price.toLocaleString('fa-IR')} تومان</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">تخفیف:</span>
                            <span>${order.discount_price ? order.discount_price.toLocaleString('fa-IR') + ' تومان' : 'ندارد'}</span>
                        </div>
                    </div>
                    
                    <div class="order-actions">
                        ${actionButton}
                    </div>
                `;
                
                container.appendChild(orderElement);
            });
        }

        function cancelOrder(orderId) {
            if (!confirm('آیا از لغو این سفارش مطمئن هستید؟')) {
                return;
            }
            
            fetch(`/cart/vendor_orders/${orderId}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                },
                body: JSON.stringify({
                    status: 'cancelled'
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('مشکل در لغو سفارش');
                }
                return response.json();
            })
            .then(data => {
                showMessage('سفارش با موفقیت لغو شد', 'success');
                fetchOrders(); // بارگذاری مجدد لیست سفارش‌ها
            })
            .catch(error => {
                showMessage(error.message, 'error');
                console.error('Error:', error);
            });
        }

        function showMessage(message, type) {
            const container = document.getElementById('message-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
    </script>
{% endblock %}
</body>
</html>