{% extends 'base.html' %}
{% load static %}
{% block title %}مدیرت سفارش‌های فروشگاه{% endblock %}
{% block content %}

    <div class="container">
        <h1>سفارش‌های فروشگاه</h1>
        
        <div id="message-container"></div>
        
        <div id="orders-container">
            <div class="loading">در حال دریافت اطلاعات سفارش‌ها...</div>
        </div>
    </div>
    <a href="http://127.0.0.1:8000/register/vendor_panel/" class="return-btn w-100 mt-2">بازگشت</a>
{% endblock %}

{% block custom_script %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetchOrders();
        });

        function fetchOrders() {
            fetch('/cart/vendor_orders/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('مشکل در دریافت سفارش‌ها');
                }
                return response.json();
            })
            .then(data => {
                renderOrders(data);
            })
            .catch(error => {
                showMessage(error.message, 'error');
                console.error('Error:', error);
            });
        }

        function renderOrders(orders) {
            const container = document.getElementById('orders-container');
            
            if (orders.length === 0) {
                container.innerHTML = '<div class="no-orders">هیچ سفارشی یافت نشد</div>';
                return;
            }
            
            container.innerHTML = '';
            
            orders.forEach(order => {
                const orderElement = document.createElement('div');
                orderElement.className = 'order-card';
                
                // تعیین کلاس وضعیت سفارش
                let statusClass = 'status-pending';
                let statusText = 'در انتظار پرداخت';
                
                if (order.status === 'cancelled') {
                    statusClass = 'status-cancelled';
                    statusText = 'لغو شده';
                } else if (order.status === 'pending') {
                    statusClass = 'status-pending';
                    statusText = 'در انتظار پرداخت';
                } else if (order.status === 'processing') {
                    statusClass = 'status-processing';
                    statusText = 'در حال پردازش';
                } else if (order.status === 'shipped') {
                    statusClass = 'status-shipped';
                    statusText = 'درحال ارسال';
                } else if (order.status === 'delivered') {
                    statusClass = 'status-delivered';
                    statusText = 'تحویل داده شده';
                }

                let statusSelect = `
                    <select class="form-select status-select" data-order-id="${order.id}">
                        <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>در انتظار پرداخت</option>
                        <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>در حال پردازش</option>
                        <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>درحال ارسال</option>
                        <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>تحویل داده شده</option>
                        <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>لغو شده</option>
                    </select>
                `;
                
                orderElement.innerHTML = `
                    <div class="order-header">
                        <div>
                            <h3 class="order-id">سفارش #${order.id}</h3>
                            <span class="order-date">${new Date(order.order_date).toLocaleString('fa-IR')}</span>
                        </div>
                        <span class="order-status ${statusClass}">${statusText}</span>
                    </div>
                    
                    <div class="order-details">
                        <div class="detail-row">
                            <span class="detail-label">مشتری:</span>
                            <span>${order.customer}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">مبلغ کل:</span>
                            <span>${order.total_price.toLocaleString('fa-IR')} تومان</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">آدرس مشتری : </span>
                            <span>${order.address}</span>
                        </div>
                    </div>
                    
                    <div class="order-actions">
                        <div class="status-select-container">
                            <span class="detail-label">تغییر وضعیت:</span>
                            ${statusSelect}
                        </div>
                    </div>
                `;
                
                container.appendChild(orderElement);
            });

            // اضافه کردن event listener برای selectها
            document.querySelectorAll('.status-select').forEach(select => {
                select.addEventListener('change', function() {
                    updateOrderStatus(this.dataset.orderId, this.value);
                });
            });
        }

        function updateOrderStatus(orderId, newStatus) {
            if (!confirm(`آیا از تغییر وضعیت سفارش به "${getStatusText(newStatus)}" مطمئن هستید؟`)) {
                return;
            }
            
            fetch(`/cart/vendor_orders/${orderId}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                },
                body: JSON.stringify({
                    status: newStatus
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('مشکل در تغییر وضعیت سفارش');
                }
                return response.json();
            })
            .then(data => {
                showMessage('وضعیت سفارش با موفقیت به‌روزرسانی شد', 'success');
                fetchOrders(); // بارگذاری مجدد لیست سفارش‌ها
            })
            .catch(error => {
                showMessage(error.message, 'error');
                console.error('Error:', error);
            });
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'در انتظار پرداخت',
                'processing': 'در حال پردازش',
                'shipped': 'درحال ارسال',
                'delivered': 'تحویل داده شده',
                'cancelled': 'لغو شده'
            };
            return statusMap[status] || status;
        }

        function showMessage(message, type) {
            const container = document.getElementById('message-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
    </script>

    <style>
        .order-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #fff;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .order-id {
            font-weight: bold;
            margin-left: 10px;
        }
        
        .order-date {
            color: #666;
            font-size: 0.9em;
        }
        
        .order-status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-processing {
            background-color: #cce5ff;
            color: #004085;
        }
        
        .status-shipped {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-delivered {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .status-cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .detail-row {
            margin-bottom: 8px;
            display: flex;
        }
        
        .detail-label {
            font-weight: bold;
            min-width: 100px;
            display: inline-block;
        }
        
        .order-actions {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-select-container {
            display: flex;
            align-items: center;
        }
        
        .status-select {
            width: 180px;
            margin-right: 10px;
        }
        
        .btn-details {
            background-color: #17a2b8;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            text-decoration: none;
        }
        
        .btn-details:hover {
            background-color: #138496;
            color: white;
        }
        
        .no-orders {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .alert {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
{% endblock %}