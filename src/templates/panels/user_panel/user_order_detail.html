{% extends 'base.html' %}
{% load static %}
{% block title %}جزئیات سفارش{% endblock %}
{% block content %}
<div class="container">
    <h1>جزئیات سفارش</h1>
    
    <div id="message-box" class="alert"></div>
    
    <div id="orders-container"></div>

    <a href="http://127.0.0.1:8000/register/user_order/" class="return-btn w-25 mt-2">بازگشت</a>
</div>
{% endblock %}

{% block custom_script %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetchOrders();
        });

        function fetchOrders() {
            fetch('/cart/user_order_detail/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('مشکل در دریافت سفارش‌ها');
                }
                return response.json();
            })
            .then(data => {
                renderOrders(data);
            })
            .catch(error => {
                showMessage(error.message, 'danger');
                console.error('Error:', error);
            });
        }

        function renderOrders(data) {
            const container = document.getElementById('orders-container');
            container.innerHTML = '';

            data.forEach(order => {
                const totalPrice = Number(order.single_price) * Number(order.quantity);
            
                const orderElement = document.createElement('div');
                orderElement.classList.add('order-card');
            
                orderElement.innerHTML = `
                    <h3>سفارش شماره : ${order.order}</h3>
                    <p>نام محصول : ${order.product_name}</p>
                    <p>قیمت واحد : ${Number(order.single_price).toLocaleString('fa-IR')} تومان</p>
                    <p>تعداد : ${order.quantity}</p>
                    <p>قیمت کل : ${totalPrice.toLocaleString('fa-IR')} تومان</p>
                `;
            
                container.appendChild(orderElement);
            });
        }


        function cancelOrder(orderId) {
            if (!orderId) {
                showMessage('شناسه سفارش نامعتبر است', 'danger');
                return;
            }
            if (!confirm('آیا از لغو این سفارش مطمئن هستید؟')) {
                return;
            }
            
            fetch(`/cart/user_orders/${orderId}/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('مشکل در لغو سفارش');
                }
                return response.json();
            })
            .then(data => {
                showMessage('سفارش با موفقیت لغو شد', 'success');
                fetchOrders(); // بارگذاری مجدد سفارش‌ها
            })
            .catch(error => {
                showMessage(error.message, 'danger');
                console.error('Error:', error);
            });
        }

        function showMessage(message, type) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.className = `alert alert-${type}`;
            messageBox.style.display = 'block';
            
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }
    </script>
{% endblock %}
</body>
</html>