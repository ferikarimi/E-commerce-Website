{% extends 'base.html' %}
{% load static %}
{% block title %}فروشگاه آنلاین{% endblock %}
{% block content %}

	<div class="site-wrap">

		<div class="container my-3">
			<div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
			  <input type="search" placeholder="جستجوی نام محصولات" aria-label="Search" id="searchInput"
				style="padding: 8px; width: 300px; border-radius: 4px; border: 1px solid #ddd;" />
		  
			  <select id="sort-select" class="form-control" style="width: 200px;">
				<option value="">مرتب سازی</option>
				<option value="ارزان‌ترین">ارزان‌ترین</option>
				<option value="گران‌ترین">گران‌ترین</option>
				<option value="کمترین امتیاز">کمترین امتیاز</option>
				<option value="بیشترین امتیاز">بیشترین امتیاز</option>
				<!-- <option value="کم فروش‌ترین">کم فروش‌ترین</option> -->
				<!-- <option value="پر فروش‌ترین">پر فروش‌ترین</option> -->
				<option value="قدیمی ترین">قدیمی ترین</option>
			  </select>
			</div>
			<div id="message-box" class="alert d-none" style="padding: 10px; width: 300px; margin: 10px 0; border-radius: 4px;"></div>
		  </div>
					
			<div class="row" id="product-container"></div>
			<div id="pagination" class="my-4"></div>
		  </div>
	</div>
{% endblock %}
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/moment-jalaali@0.9.2/build/moment-jalaali.js"></script>

{% block custom_script %}

	<script>
	let allProducts = []; // ذخیره همه محصولات

	async function addToCart(productId) {
	    try {
	        const response = await fetch('http://127.0.0.1:8000/cart/cart/', {
	            method: 'POST',
	            headers: {
	                'Content-Type': 'application/json',
	                'Accept': 'application/json'
	            },
	            body: JSON.stringify({
	                product_id: productId,
	                quantity: 1 // تعداد پیشفرض که میخوای اضافه بشه
	            })
	        });
		
	        if (!response.ok) {
	            throw new Error('خطا در افزودن به سبد خرید');
	        }
		
	        const result = await response.json();
	        alert('محصول به سبد خرید اضافه شد!');
	    } catch (error) {
	        console.error('Error adding to cart:', error);
	        alert('مشکلی پیش آمده. لطفا دوباره تلاش کنید.');
	    }
	}

	document.addEventListener('DOMContentLoaded', function () {
		let currentPage = 1;
	    let currentSort = '';
		fetchProducts({ page: currentPage });

	    const productContainer = document.getElementById('product-container');
	    const sortSelect = document.getElementById('sort-select');
	    const paginationContainer = document.getElementById('pagination');
	    const searchInput = document.getElementById('searchInput');




	    // تابع نمایش پیام
		function showMessage(message, type) {
	        const messageBox = document.getElementById('message-box');
	        messageBox.textContent = message;
	        messageBox.className = `alert alert-${type}`;
	        messageBox.style.display = 'block';
				
	        setTimeout(() => {
	            messageBox.style.display = 'none';
	        }, 5000);
	    }


		function fetchProducts({ searchTerm = '', page = 1 } = {}) {
		    currentSearchTerm = searchTerm;
			let url = `/product/all_product/?page=${page}`; 
			if (searchTerm) {
    		    url += `&search=${encodeURIComponent(searchTerm)}`;
    		}
    		if (currentSort) {
    		    url += `&sort=${currentSort}`;
    		}
		
			fetch(url)
        		.then(response => response.json())
        		.then(data => {
        		    allProducts = data.results;
        		    renderProducts(data.results);
        		    renderPagination(data.count, data.next, data.previous);
        		})
        		.catch(error => console.error('Error:', error));
		}


	    // تابع نمایش محصولات
	    function renderProducts(products) {
	        productContainer.innerHTML = '';
	        products.forEach(product => {
	            const productHtml = `
	                <div class="product-card">
	                    <img src="${product.image}" alt="${product.name}" class="product-image"/>
	                    <div class="product-info">
	                        <div>
	                            <h3>نام: ${product.name}</h3>
	                            <p>امتیاز: ${product.rating || 'نامشخص'}</p>
	                            <p>قیمت: ${product.final_price} تومان</p>
	                            ${product.discount > 0 ? `<p>تخفیف: ${product.discount}%</p>` : ''}
	                            <p>فروشگاه: ${product.shop_name || 'نامشخص'}</p>
	                            <p>باقی مانده : ${product.stock}</p>

	                        </div>
                    		<div class="product-buttons">
                    		    <button onclick="addToCart(${product.id})" class="btn2 mb-2">
                    		        افزودن به سبد خرید
                    		    </button>
                    		    <a href="http://127.0.0.1:8000/register/single_product/${product.id}/" class="btn mb-2">
                    		        جزئیات محصول
                    		    </a>
                    		</div>
	                    </div>
	                </div>
	            `;
	            productContainer.innerHTML += productHtml;
	        });
	    }


	    // تابع نمایش صفحه‌بندی
	    function renderPagination(count, next, previous) {
	        paginationContainer.innerHTML = '';
	        if (previous) {
	            const prevButton = document.createElement('button');
	            prevButton.textContent = 'صفحه قبل';
	            prevButton.onclick = () => {
	                currentPage--;
	                fetchProducts({ searchTerm: currentSearchTerm, page: currentPage });
	            };
	            paginationContainer.appendChild(prevButton);
	        }
	        const pageInfo = document.createElement('span');
	        pageInfo.textContent = ` صفحه ${currentPage}`;
	        paginationContainer.appendChild(pageInfo);
	        if (next) {
	            const nextButton = document.createElement('button');
	            nextButton.textContent = 'صفحه بعد';
	            nextButton.onclick = () => {
	                currentPage++;
	                fetchProducts({ searchTerm: currentSearchTerm, page: currentPage });
	            };
	            paginationContainer.appendChild(nextButton);
	        }
	    }

	    // رویداد جستجو
		searchInput.addEventListener('input', function(e) {
		    const searchText = e.target.value.trim();
    		currentPage = 1;
    		fetchProducts({ searchTerm: searchText, page: currentPage });
		});


	    // رویداد مرتب‌سازی
	    sortSelect.addEventListener('change', function () {
	        const selectedValue = sortSelect.value;
	        switch (selectedValue) {
	            case 'ارزان‌ترین':
	                currentSort = 'cheap';
	                break;
	            case 'گران‌ترین':
	                currentSort = 'expensive';
	                break;
	            case 'کمترین امتیاز':
	                currentSort = 'lowest_score';
	                break;
	            case 'بیشترین امتیاز':
	                currentSort = 'highest_score';
	                break;
	            // case 'کم فروش‌ترین':
	            //     currentSort = 'badseller';
	            //     break;
	            // case 'پر فروش‌ترین':
	            //     currentSort = 'bestseller';
	            //     break;
	            case 'قدیمی ترین':
	                currentSort = 'oldest';
	                break;
	            default:
	                currentSort = '';
	        }
	        currentPage = 1;
	        fetchProducts({ searchTerm: currentSearchTerm, page: currentPage });
	    });

	    // بارگیری اولیه محصولات
	    fetchProducts();
	});

	document.addEventListener('DOMContentLoaded', function() {
	    const panelLink = document.getElementById('user-panel-link');
	    if (panelLink) {
	        panelLink.addEventListener('click', function(event) {
	            event.preventDefault();
	            const accessToken = localStorage.getItem("access_token");
	            if (!accessToken) {
	                window.location.href = "http://127.0.0.1:8000/register/login/";
	                return;
	            }
	            fetch("/users/check_user_type/", {
	                method: 'GET',
	                headers: {
	                    "Authorization": `Bearer ${accessToken}`,
	                    "Content-Type": "application/json"
	                }
	            })
	            .then(response => {
	                if (!response.ok) throw new Error("خطا در پاسخ سرور");
	                return response.json();
	            })
	            .then(data => {
	                if (data.is_superuser){
	                    window.location.href = "http://127.0.0.1:8000/register/admin_panel/";
	                } else if (data.is_vendor) {
	                    window.location.href = "http://127.0.0.1:8000/register/vendor_panel/";
	                } else if (data.is_customer) {
	                    window.location.href = "http://127.0.0.1:8000/register/user_panel/";
	                } else {
	                    window.location.href = "http://127.0.0.1:8000/register/home/";
					}
	            })
	            .catch(error => {
	                console.error("خطا:", error);
	                window.location.href = "http://127.0.0.1:8000/register/login/";
	            });
	        });
	    }
	});

	function updateDateTime() {
	  const now = moment();
	  const jalaliDateTime = now.format('jYYYY/jMM/jDD HH:mm');
	  document.getElementById('current-date-time').innerText = jalaliDateTime;
	}

	setInterval(updateDateTime, 1000);
	updateDateTime();

	</script>
{% endblock %}
</body>
</html>