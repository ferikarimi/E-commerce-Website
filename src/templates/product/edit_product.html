{% extends 'base.html' %}

<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>ویرایش محصول</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

</head>
{% block content %}
<body class="bg-light">

<div class="form-container">
  <h2 class="mb-4 text-center">ویرایش محصول</h2>

  <div id="error-message" class="alert alert-danger d-none"></div>
  <div id="success-message" class="alert alert-success d-none"></div>

  <form id="product-form">
    <div class="mb-3">
      <label class="form-label">دسته بندی</label>
      <input type="number" class="form-control ltr-input" name="category">
    </div>

    <div class="mb-3">
      <label class="form-label">نام محصول</label>
      <input type="text" class="form-control ltr-input" name="name">
    </div>

    <div class="mb-3">
      <label class="form-label">توضیحات</label>
      <textarea class="form-control ltr-input" name="description" rows="4"></textarea>
    </div>

    <div class="mb-3">
      <label class="form-label">قیمت (تومان)</label>
      <input type="number" step="0.01" class="form-control ltr-input" name="price">
    </div>

    <div class="mb-3">
      <label class="form-label">مبلغ تخفیف (تومان)</label>
      <input type="number" step="0.01" class="form-control ltr-input" name="discount_amount">
    </div>

    <div class="mb-3">
      <label class="form-label">درصد تخفیف (%)</label>
      <input type="number" step="0.01" class="form-control ltr-input" name="discount_percentage">
    </div>

    <div class="mb-3">
      <label class="form-label">موجودی</label>
      <input type="number" class="form-control ltr-input" name="stock">
    </div>

    <div class="mb-3">
      <label class="form-label">تصویر محصول (در صورت نیاز به تغییر)</label>
      <input type="file" class="form-control ltr-input" name="image">
    </div>

    <button type="submit" class="btn btn-primary w-100">ذخیره تغییرات</button>
    <a href="http://127.0.0.1:8000/register/vendor_panel/" class="btn btn-secondary w-100 mt-2">بازگشت</a>
  </form>
</div>
{% endblock %}

{% block custom_script %}
<script>
  const form = document.getElementById('product-form');
  const errorBox = document.getElementById('error-message');
  const successBox = document.getElementById('success-message');
  const accessToken = localStorage.getItem('access_token');


  const pathParts = window.location.pathname.split('/');
  const productId = pathParts[pathParts.length - 2];

  if (!productId) {
    errorBox.innerHTML = 'شناسه محصول مشخص نیست.';
    errorBox.classList.remove('d-none');
  } else {
    loadProduct();
  }

  function loadProduct() {
    fetch(`/product/edit_product/${productId}/`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + accessToken,
      }
    })
    .then(response => {
      if (!response.ok) throw new Error("خطا در دریافت اطلاعات محصول");
      return response.json();
    })
    .then(data => {
      form.category.value = data.category;
      form.name.value = data.name;
      form.description.value = data.description;
      form.price.value = data.price;
      form.stock.value = data.stock;
      form.discount_amount.value = data.discount_amount || '';
      form.discount_percentage.value = data.discount_percentage || '';


    })
    .catch(error => {
      errorBox.innerHTML = error.message;
      errorBox.classList.remove('d-none');
    });
  }

  form.addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(form);

    fetch(`/product/edit_product/${productId}/`, {
      method: 'PUT',
      headers: {

        'Authorization': 'Bearer ' + accessToken,
      },
      body: formData
    })
    .then(response => {
      if (response.ok) {
        successBox.innerHTML = 'محصول با موفقیت ویرایش شد.';
        successBox.classList.remove('d-none');
        errorBox.classList.add('d-none');
      } else {
        return response.json().then(err => {
          errorBox.innerHTML = 'خطا: ' + JSON.stringify(err);
          errorBox.classList.remove('d-none');
          successBox.classList.add('d-none');
        });
      }
    })
    .catch(error => {
      errorBox.innerHTML = 'خطا در ارتباط با سرور.';
      errorBox.classList.remove('d-none');
    });
  });
</script>
{% endblock %}
</body>
</html>
