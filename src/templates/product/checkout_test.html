<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>

<div class="container mt-5">
    <h2>Checkout</h2>
    <div id="message-box" class="alert d-none"></div>

    <form id="checkout-form">
        <div class="form-group">
            <label for="address">Select Address</label>
            <select class="form-control" id="address" name="address_id" required>
                <!-- آدرس‌ها در اینجا نمایش داده می‌شوند -->
            </select>
        </div>
        
        <h4>Items in your cart:</h4>
        <div id="cart-items">
            <!-- جزئیات سبد خرید (محصولات) اینجا قرار می‌گیرند -->
        </div>

        <button type="submit" class="btn btn-primary">Complete Order</button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    fetchCartItems();
    fetchAddresses();
    
    document.getElementById('checkout-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const data = {};
        formData.forEach((value, key) => { data[key] = value });
        
        fetch('/cart/checkout/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(body => {
            if (body.detail) {
                showMessage(body.detail, 'success');
            } else {
                showMessage('Error: ' + body.error, 'danger');
            }
        })
        .catch(error => {
            showMessage('Something went wrong.', 'danger');
        });
    });
});

function fetchCartItems() {
    fetch('/api/cart/')
    .then(response => response.json())
    .then(cart => {
        let cartHtml = '';
        cart.items.forEach(item => {
            cartHtml += `
                <p>${item.product_name} - Quantity: ${item.quantity} - Price: ${item.total_price}</p>
            `;
        });
        document.getElementById('cart-items').innerHTML = cartHtml;
    })
    .catch(error => {
        showMessage('Unable to load cart items.', 'danger');
    });
}

function fetchAddresses() {
    fetch('/customer/address/all')
    .then(response => response.json())
    .then(addresses => {
        let optionsHtml = '';
        addresses.forEach(address => {
            optionsHtml += `<option value="${address.id}">${address.city} - ${address.address}</option>`;
        });
        document.getElementById('address').innerHTML = optionsHtml;
    })
    .catch(error => {
        showMessage('Unable to load addresses.', 'danger');
    });
}

function showMessage(message, type) {
    const messageBox = document.getElementById('message-box');
    messageBox.className = 'alert alert-' + type;
    messageBox.innerHTML = message;
    messageBox.classList.remove('d-none');
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

</body>
</html>
