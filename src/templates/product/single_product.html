{% extends 'base.html' %}

<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>جزئیات محصول</title>

</head>
<body>
{% block content %}
<!-- پیام‌ها اینجا نمایش داده می‌شوند -->
<div id="message-box" class="alert d-none"></div>

<div class="product-detail" id="product-detail">
    <!-- جزئیات محصول اینجا لود میشه -->
</div>

<div class="reviews" id="reviews">
    <!-- کامنت ها اینجا لود میشه -->
</div>

<div class="comment-form" id="comment-form">
    <h2>کامنت خود را بنویسید</h2>
    <form id="reviewForm">
        <div class="form-group">
            <label for="rating">امتیاز:</label>
            <select name="rating" id="rating" required>
                <option value="">انتخاب کنید</option>
                <option value="1">1 ستاره</option>
                <option value="2">2 ستاره</option>
                <option value="3">3 ستاره</option>
                <option value="4">4 ستاره</option>
                <option value="5">5 ستاره</option>
            </select>
        </div>
        <div class="form-group">
            <label for="comment">نظر شما:</label>
            <textarea name="comment" id="comment" required></textarea>
        </div>
        <button type="submit">ارسال کامنت</button>
    </form>
</div>

<a href="/" class="return-btn w-100 mt-2">بازگشت</a>
{% endblock %}

{% block custom_script %}
<script>

    document.addEventListener('DOMContentLoaded', () => {

        const productIdMatch = window.location.pathname.match(/\/single_product\/(\d+)\/?$/);
        const productId = productIdMatch ? productIdMatch[1] : null;
        
        if (!productId) {
            showMessage('محصول یافت نشد', 'danger');
            return;
        }
        fetchProductDetails(productId);
        fetchReviews(productId);
        setupReviewForm(productId);
    });

    function fetchProductDetails(productId) {
        fetch(`/product/single_product/${productId}/`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',

            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('مشکل در دریافت اطلاعات محصول');
            }
            return response.json();
        })
        .then(product => {
            renderProductDetails(product);
        })
        .catch(error => {
            showMessage(error.message, 'danger');
            console.error('Error:', error);
        });
    }

    function renderProductDetails(product) {
        const container = document.getElementById('product-detail');
        container.innerHTML = `
            <img src="${product.image || 'https://via.placeholder.com/500x300'}" alt="${product.name}" class="product-image">
            <div class="product-info">
                <h2>نام محصول : ${product.name}</h2>
                <p class="price">قیمت : ${product.price} تومان</p>
                <p>موجودی : ${product.stock}</p>
                <p>امتیاز : ${product.rating} / 5</p>
                <p>دسته‌بندی : ${product.category}</p>
                <p>فروشگاه : ${product.store_name}</p>
                <p>توضیحات محصول : ${product.description}</p>
            </div>
        `;
    }

    function fetchReviews(productId) {
        fetch(`/product/product_reviews/${productId}/`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('مشکل در دریافت نظرات');
            }
            return response.json();
        })
        .then(reviews => {
            renderReviews(reviews);
        })
        .catch(error => {
            showMessage(error.message, 'warning');
            console.error('Error loading reviews:', error);
        });
    }

    function renderReviews(reviews) {
        const container = document.getElementById('reviews');
        container.innerHTML = '<h2>نظرات کاربران</h2>';
        
        if (reviews && reviews.length > 0) {
            reviews.forEach(review => {
                container.innerHTML += `
                    <div class="review-item">
                        <p><strong> کاربر : ${review.customer_name || 'کاربر ناشناس'}</strong> <p>
                        <p>امتیاز محصول : ${review.rating} ستاره</p>
                        <p>نظر کاربر : ${review.comment}</p>
                    </div>
                `;
            });
        } else {
            container.innerHTML += '<p>هنوز نظری ثبت نشده است.</p>';
        }
    }

    function setupReviewForm(productId) {
        const form = document.getElementById('reviewForm');
        
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            submitReview(productId);
        });
    }

    function submitReview(productId) {
        const rating = document.getElementById('rating').value;
        const comment = document.getElementById('comment').value;
        const token = localStorage.getItem('access_token');
        
        // فقط بررسی می‌کنیم که نظر خالی نباشد
        if (!comment) {
            showMessage('لطفاً نظر خود را وارد کنید', 'warning');
            return;
        }

        // اگر کاربر امتیاز داده، بررسی می‌کنیم که بین 1 تا 5 باشد
        if (rating && (rating < 1 || rating > 5)) {
            showMessage('امتیاز باید بین 1 تا 5 باشد', 'warning');
            return;
        }

        if (!token) {
            showMessage('برای ثبت نظر باید وارد حساب کاربری خود شوید', 'danger');
            return;
        }

        fetch(`/product/product_reviews/${productId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}` // اضافه کردن توکن به هدر

            },
            body: JSON.stringify({
                rating: rating || null,
                comment: comment
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw err; });
            }
            return response.json();
        })
        .then(data => {
            showMessage('نظر شما با موفقیت ثبت شد', 'success');
            document.getElementById('reviewForm').reset();
            fetchReviews(productId); // بارگذاری مجدد نظرات
        })
        .catch(error => {
            const errorMsg = error.message || Object.values(error).join(', ') || 'خطا در ثبت نظر';
            showMessage(errorMsg, 'danger');
            console.error('Error:', error);
        });
    }

    // نمایش پیام‌ها
    function showMessage(message, type) {
        const messageBox = document.getElementById('message-box');
        messageBox.textContent = message;
        messageBox.className = `alert alert-${type}`;
        messageBox.classList.remove('d-none');
        
        // مخفی کردن خودکار پیام بعد از 5 ثانیه
        setTimeout(() => {
            messageBox.classList.add('d-none');
        }, 5000);
    }
</script>
{% endblock %}
</body>
</html>