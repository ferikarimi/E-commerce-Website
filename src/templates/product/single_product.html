{% extends 'base.html' %}
{% load static %}
{% block title %}جزئیات محصول{% endblock %}
{% block content %}

<div class="container my-4">
    <!-- پیام‌های سیستمی -->
    <div id="message-box" class="alert alert-dismissible fade show d-none">
        <span id="message-text"></span>
        <button type="button" class="btn-close" onclick="dismissMessage()"></button>
    </div>

    <!-- بخش محصول -->
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-body" id="product-detail">
                    <!-- محتوای محصول اینجا لود می‌شود -->
                </div>
            </div>

            <!-- بخش نظرات -->
            <div class="card">
                <div class="card-header bg-light">
                    <h4 class="mb-0">نظرات کاربران</h4>
                </div>
                <div class="card-body" id="reviews">
                    <!-- نظرات اینجا لود می‌شود -->
                </div>
            </div>
        </div>

        <!-- فرم ارسال نظر -->
        <div class="col-md-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header bg-light">
                    <h4 class="mb-0">ثبت نظر جدید</h4>
                </div>
                <div class="card-body">
                    <form id="reviewForm">

                        <div class="mb-3">
                            <label for="comment" class="form-label">متن نظر:</label>
                            <textarea class="form-control" id="comment" rows="5" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">ارسال نظر</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <a href="/" class="return-btn w-100 mt-2">بازگشت</a>
    </div>
</div>

{% endblock %}

{% block custom_script %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const productIdMatch = window.location.pathname.match(/\/single_product\/(\d+)\/?$/);
        const productId = productIdMatch ? productIdMatch[1] : null;
        
        if (!productId) {
            showMessage('محصول یافت نشد', 'danger');
            return;
        }
        
        fetchProductDetails(productId);
        fetchReviews(productId);
        setupReviewForm(productId);
    });

    function renderProductDetails(product) {
        const container = document.getElementById('product-detail');
        container.innerHTML = `
            <div class="row">
                <div class="col-md-5 mb-3 mb-md-0">
                    <img src="${product.image || '{% static "images/default-product.png" %}'}" 
                         alt="${product.name}" 
                         class="img-fluid rounded border"
                         style="max-height: 300px; width: auto;">
                </div>
                <div class="col-md-7">
                    <h2 class="fw-bold">${product.name}</h2>
                    <p>امتیاز : ${product.rating}</p>
                    <p>دسته بندی : ${product.category}</p>
                    <p>قیمت : ${product.price} تومان</p>
                    <p>تعداد : ${product.stock}</p>
                    <p class="text-muted mb-4">توضیحات : ${product.description || 'توضیحاتی برای این محصول ثبت نشده است.'}</p>
                    <button class="btn btn-primary flex-grow-1">
                            <i class="fas fa-cart-plus me-2"></i> افزودن به سبد</button>
                </div>
            </div>
        `;
    }

    function renderReviews(reviews) {
        const container = document.getElementById('reviews');
        
        if (!reviews || reviews.length === 0) {
            container.innerHTML = '<p class="text-muted text-center py-3">هنوز نظری ثبت نشده است.</p>';
            return;
        }
        
        let html = '<div class="list-group list-group-flush">';
        reviews.forEach(review => {
            html += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between mb-2">
                        <strong>${review.customer_name || 'کاربر ناشناس'}</strong>
                        <small class="text-muted">${new Date(review.created_at).toLocaleDateString('fa-IR')}</small>
                    </div>
                    <p class="mb-0">${review.comment}</p>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
    }

    function fetchProductDetails(productId) {
        fetch(`/product/single_product/${productId}/`)
            .then(response => {
                if (!response.ok) throw new Error('مشکل در دریافت اطلاعات محصول');
                return response.json();
            })
            .then(product => renderProductDetails(product))
            .catch(error => {
                showMessage(error.message, 'danger');
                console.error('Error:', error);
            });
    }

    function fetchReviews(productId) {
        fetch(`/product/product_reviews/${productId}/`)
            .then(response => {
                if (!response.ok) throw new Error('مشکل در دریافت نظرات');
                return response.json();
            })
            .then(reviews => renderReviews(reviews))
            .catch(error => {
                showMessage(error.message, 'warning');
                console.error('Error:', error);
            });
    }

    function setupReviewForm(productId) {
        const form = document.getElementById('reviewForm');
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            submitReview(productId);
        });
    }

    function submitReview(productId) {
        const comment = document.getElementById('comment').value.trim();
        const token = localStorage.getItem('access_token'); 

        if (!comment) {
            showMessage('لطفاً نظر خود را وارد کنید', 'warning');
            return;
        }

        if (!token) {
            showMessage('لطفاً ابتدا وارد حساب کاربری خود شوید', 'danger');
            return;
        }

        fetch(`/product/product_reviews/${productId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}` 
            },
            body: JSON.stringify({ comment })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw err; });
            }
            return response.json();
        })
        .then(data => {
            document.getElementById('reviewForm').reset();
            showMessage('نظر شما با موفقیت ثبت شد.', 'success');
            fetchReviews(productId);
        })
        .catch(error => {
            const msg = error.detail || 'ارسال نظر با خطا مواجه شد.';
            showMessage(msg, 'danger');
            console.error('Error:', error);
        });
    }

    function showMessage(message, type = 'info') {
        const box = document.getElementById('message-box');
        const text = document.getElementById('message-text');
        box.classList.remove('d-none', 'alert-info', 'alert-danger', 'alert-warning', 'alert-success');
        box.classList.add(`alert-${type}`);
        text.textContent = message;
    }

    function dismissMessage() {
        const box = document.getElementById('message-box');
        box.classList.add('d-none');
    }

</script>
{% endblock %}
</body>
</html>