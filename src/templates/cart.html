<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>سبد خرید</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 30px;
            background-color: #f8f9fa;
        }
        table {
            width: 80%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        table, th, td {
            border: 1px solid #aaa;
        }
        th, td {
            padding: 10px;
            text-align: center;
        }
        .total {
            font-weight: bold;
            font-size: 18px;
            margin-top: 20px;
        }
        .cart-actions button {
            margin: 0 2px;
            padding: 4px 8px;
            cursor: pointer;
        }
        .checkout-button {
            padding: 10px 20px;
            background-color: green;
            color: white;
            text-decoration: none;
            font-weight: bold;
            border-radius: 5px;
            display: inline-block;
        }
        .login-alert {
            color: red;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>

    <h1>سبد خرید شما</h1>

    <table id="cart-table" style="display: none;">
        <thead>
            <tr>
                <th>نام محصول</th>
                <th>قیمت واحد</th>
                <th>تعداد</th>
                <th>قیمت کل</th>
                <th>عملیات</th>
            </tr>
        </thead>
        <tbody id="cart-body">
            <!-- آیتم‌های سبد خرید اینجا اضافه میشه -->
        </tbody>
    </table>

    <div class="total" id="total-price" style="display: none;"></div>

    <div id="checkout" style="margin-top: 20px; display: none;">
        <a href="#" class="checkout-button" id="checkout-btn">نهایی کردن خرید</a>
        <div id="login-alert" class="login-alert">برای نهایی کردن خرید باید وارد حساب کاربری خود شوید.</div>
		<a href="http://127.0.0.1:8000/register/home/" class="btn btn-secondary w-100 mt-2">بازگشت</a>
    </div>

    <p id="empty-cart" style="display: none;">سبد خرید شما خالی است.</p>

    <script>
        const accessToken = localStorage.getItem('access_token');
        const checkoutBtn = document.getElementById('checkout-btn');
        const loginAlert = document.getElementById('login-alert');

        // تابع بررسی لاگین و هدایت به صفحه لاگین در صورت نیاز
        function checkAuthAndProceed(e) {
            if (!accessToken) {
                e.preventDefault();
                loginAlert.style.display = 'block';
                // هدایت به صفحه لاگین با ذخیره آدرس بازگشت
                window.location.href = "/register/login/";
            } else {
				window.location.href = "http://127.0.0.1:8000/register/checkout/";
			}
            // اگر توکن وجود دارد، اجازه ادامه کار داده می‌شود
        }

        // بارگذاری سبد خرید بدون نیاز به احراز هویت
        document.addEventListener('DOMContentLoaded', function() {
            loadCart();
            
            // اضافه کردن هندلر برای دکمه نهایی کردن خرید
            checkoutBtn.addEventListener('click', checkAuthAndProceed);
        });

        async function loadCart() {
            try {
                const response = await fetch('/cart/cart/', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'include' // برای ارسال کوکی‌ها
                });
                
                if (!response.ok) {
                    throw new Error('خطا در دریافت سبد خرید');
                }
                
                const data = await response.json();

                const cartItems = data.cart_items;
                const totalPrice = data.total_cart_price;

                if (cartItems.length === 0) {
                    document.getElementById('empty-cart').style.display = 'block';
                } else {
                    const cartBody = document.getElementById('cart-body');
                    cartBody.innerHTML = '';

                    cartItems.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.name}</td>
                            <td>${item.price}</td>
                            <td>${item.quantity}</td>
                            <td>${item.total_price}</td>
                            <td class="cart-actions">
                                <button onclick="updateCart(${item.product_id}, 'increase')">+</button>
                                <button onclick="updateCart(${item.product_id}, 'decrease')">-</button>
                                <button onclick="updateCart(${item.product_id}, 'remove')">حذف</button>
                            </td>
                        `;
                        cartBody.appendChild(row);
                    });

                    document.getElementById('cart-table').style.display = 'table';
                    const totalDiv = document.getElementById('total-price');
                    totalDiv.textContent = `مجموع کل سبد خرید: ${totalPrice} تومان`;
                    totalDiv.style.display = 'block';

                    document.getElementById('checkout').style.display = 'block';
                }
            } catch (error) {
                console.error(error);
            }
        }

        async function updateCart(productId, action) {
            try {
                const response = await fetch('/cart/cart/', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include', // برای ارسال کوکی‌ها
                    body: JSON.stringify({
                        product_id: productId,
                        action: action
                    })
                });
                
                if (!response.ok) {
                    throw new Error('خطا در بروزرسانی سبد خرید');
                }
                
                await loadCart();
            } catch (error) {
                console.error(error);
            }
        }
    </script>

</body>
</html>